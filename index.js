!function(e){var t={};function s(i){if(t[i])return t[i].exports;var o=t[i]={i:i,l:!1,exports:{}};return e[i].call(o.exports,o,o.exports,s),o.l=!0,o.exports}s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)s.d(i,o,function(t){return e[t]}.bind(null,o));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=0)}([function(e,t,s){"use strict";s.r(t);class i{constructor(e,t,s,i){this.start=new v(e),this.end=new v(t),this.length=s,this.next=i}}class o{constructor(e,t,s=0,i=0){e instanceof S?t instanceof S?(this.x=Math.min(e.x,t.x),this.width=Math.max(e.x,t.x)-this.x,this.y=Math.min(e.y,t.y),this.height=Math.max(e.y,t.y)-this.y):(this.x=e.x,this.y=e.y,this.width=s,this.height=i):(this.x=e,this.y=t,this.width=s,this.height=i)}get left(){return this.x}get top(){return this.y}get right(){return this.x+this.width}get bottom(){return this.y+this.height}leftTop(){return new S(this.left,this.top)}rightBottom(){return new S(this.right,this.bottom)}contains(e){return e.x>=this.left&&e.y>=this.top&&e.x<this.right&&e.y<this.bottom}intersects(e){return this.left<e.right&&e.left<this.right&&this.top<e.bottom&&e.top<this.bottom}}class n{constructor(e,t){this.pos=e.pos,this.range=e.range||0,this.duration=e.duration,this.priority=e.priority||0,this.requirements=e.requirements||{},this.onFinished=t}}var r;!function(e){e[e.Ore=0]="Ore",e[e.Crystal=1]="Crystal"}(r||(r={}));class a{constructor(e){this.amount=new Map,e instanceof a?e.amount.forEach((e,t)=>this.amount.set(t,e)):(e.ore&&this.amount.set(r.Ore,e.ore),e.crystal&&this.amount.set(r.Crystal,e.crystal))}display(){return 0==this.amount.size?"":"("+[...this.amount.entries()].map(([e,t])=>t+" "+r[e]).join(", ")+")"}remove(e,t=1){let s=this.amount.get(e);if(void 0===s)throw new Error("Attempt to remove non-available ItemType "+r[e]+" from "+this);0==(s=Math.max(0,s-t))?this.amount.delete(e):this.amount.set(e,s)}isDone(){return 0==this.amount.size}}var l;!function(e){e[e.Spawn=0]="Spawn",e[e.Lab=1]="Lab",e[e.ConstructionSite=2]="ConstructionSite",e[e.Platform=3]="Platform"}(l||(l={}));const h=[{cost:new a({ore:5,crystal:1}),buildable:!0},{cost:new a({ore:15,crystal:3}),buildable:!0},{buildable:!1},{cost:new a({ore:2}),buildable:!0}];class c{constructor(e,t,s,i={}){this.cooldown=0,this.power=!1,this.level=0,this.levelupCost=new a({ore:5}),this.parent=e,this.pos=new v(t),this.type=s,this.options=i,this.rect=new o(this.pos.x*y.tileSize,this.pos.y*y.tileSize,y.tileSize,y.tileSize),s==l.ConstructionSite&&i.cost&&this.parent.request(i.cost),s==l.Spawn?e.countResource(r.Crystal)>0&&this.setPower(!0):this.neighborMachines().find(e=>e.power)&&this.setPower(!0),s==l.Platform?I.place(t,d.Platform):I.place(t,d.Machine)}tick(){this.cooldown>0&&(this.cooldown--,0==this.cooldown&&this.options.workDone&&(this.options.workDone(),delete this.options.workDone))}freeNeighbor(){for(let e=0;e<4;e++){const t=new v(this.pos);if(t.move(e),!m.at(t).isSolid())return t}return null}neighborMachines(){return[w.UP,w.RIGHT,w.DOWN,w.LEFT].map(e=>new v(this.pos).move(e)).map(e=>this.parent.machines.at(e)).filter(e=>e)}requestedItemDelivered(e){this.type==l.Spawn&&this.parent.resources.add(e)}requestComplete(){this.type==l.ConstructionSite&&(delete this.options.cost,this.cooldown=5,this.options.workDone=(()=>{const e=this.options.result||l.Spawn;delete this.options.result,e==l.Platform&&I.place(this.pos,d.Platform),this.type=e,this.conducts()&&this.givesPower()&&this.setPower(!0)}))}givesPower(){return this.type==l.Spawn&&this.parent.countResource(r.Crystal)>0}conducts(){return this.type!=l.ConstructionSite}setPower(e){if(!this.conducts()||this.power==e)return;if(this.givesPower()&&!e)return;let t=this.neighborMachines().filter(e=>e.conducts());if(!e&&t.find(e=>e.givesPower()))return this.power=!0,void t.forEach(e=>{e.power||e.setPower(!0)});this.power=e;for(const s of t)if(s.setPower(e),this.power!=e)return}onAdd(e,t,s){e==r.Crystal&&this.type==l.Spawn&&0==t&&this.setPower(!0)}onRemove(e,t,s){e==r.Crystal&&this.type==l.Spawn&&0==s&&this.setPower(!1)}ready(){return 0==this.cooldown&&this.power}draw(e){y.drawMachine(e,this.type,this.rect),!this.power&&this.conducts()&&(e.fillStyle="rgba(0,0,0,0.3)",e.fillRect(this.rect.x,this.rect.y,this.rect.width,this.rect.height),y.drawSymbol(e,f.LowPower,this.rect))}getOutline(){return this.rect}getDescription(){return`Machine(${l[this.type]})`}getInfo(){let e="";return this.type!=l.ConstructionSite&&(e+=`\nLevel: ${this.level+1}`),this.type==l.ConstructionSite&&this.options.cost&&(e+="Requires: "+this.options.cost.display()),this.cooldown&&(e+="\nWork done in "+this.cooldown),e}getOptionMenu(e){const t=[{name:"Destroy",callback:()=>(this.parent.removeMachine(this),I.place(this.pos,d.Debris),!0)}];return this.type!=l.ConstructionSite&&t.unshift({name:"Level up "+this.levelupCost.display(),callback:()=>(this.parent.pay(this.levelupCost),this.options.workDone=(()=>this.level++),this.cooldown=4*(this.level+2),this.levelupCost.amount.set(r.Ore,5*(this.level+2)),!1),enabled:()=>this.ready()&&this.parent.isAvailable(this.levelupCost)}),this.type==l.Spawn?t.unshift({name:"Spawn Worker",callback:()=>(this.options.workDone=(()=>{if(this.freeNeighbor())throw new Error("Not implemented!");alert("Unable to spawn Worker: No free space near Spawn!")}),this.cooldown=Math.max(5,20-2*this.level),!1),enabled:()=>this.ready()&&I.scheduler.workers.hasRoom()&&null!=this.freeNeighbor()}):this.type==l.Lab&&u.filter(e=>e.available()).map(e=>({name:e.name+"\n"+e.cost.display(),callback:()=>(this.parent.pay(e.cost),this.cooldown=Math.max(5,e.time-5*this.level),this.options.workDone=e.onResearched,e.costIncrease&&(e.cost=e.costIncrease(e.cost)),!1),enabled:()=>this.ready()&&this.parent.isAvailable(e.cost)&&e.available(),hotkeys:[]})).forEach(e=>t.push(e)),t}static constructMachine(e,t){I.isFree(e)&&I.scheduler.addMachine(e,l.ConstructionSite,{cost:new a(h[t].cost||{}),result:t})}static debugMode(){for(const e of u)for(let t=0;t<20;t++)e.available()&&(e.onResearched(),e.costIncrease&&(e.cost=e.costIncrease(e.cost)))}}const u=[{name:"+Drill Level",cost:new a({ore:100,crystal:20}),time:100,onResearched:()=>{I.drillLevel++},available:()=>I.drillLevel<2,costIncrease:e=>{for(const[t,s]of e.amount)e.amount.set(t,2*s);return e}},{name:"+Drill Speed",cost:new a({ore:20}),time:20,onResearched:()=>{I.drillSpeed++},available:()=>!0,costIncrease:e=>new a({ore:e.amount.get(r.Ore)+20})},{name:"+Worker Capacity",cost:new a({crystal:10}),time:50,onResearched:()=>{I.scheduler.workers.capacity+=10},available:()=>!0,costIncrease:e=>new a({crystal:2*e.amount.get(r.Crystal)})},{name:"+Game Speed",cost:new a({ore:100,crystal:20}),time:100,onResearched:()=>{I.gameSpeed-=20},available:()=>I.gameSpeed>40,costIncrease:e=>{for(const[t,s]of e.amount)e.amount.set(t,2*s);return e}}];var d;!function(e){e[e.Air=0]="Air",e[e.Bedrock=1]="Bedrock",e[e.Granite=2]="Granite",e[e.Rock=3]="Rock",e[e.Ore=4]="Ore",e[e.Crystal=5]="Crystal",e[e.Debris=6]="Debris",e[e.Platform=7]="Platform",e[e.Machine=8]="Machine"}(d||(d={}));class m{constructor(e){this.pos=new v(e),this.rect=new o(this.pos.toGamePos(),this.pos.plus(1,1).toGamePos())}get type(){return m.wasm.get(this.pos.x,this.pos.y)}getData(){return p[this.type]}getStrength(){return this.getData().strength}isSolid(){return m.wasm.is_solid(this.pos.x,this.pos.y)}getWalkCost(){return m.wasm.walk_cost(this.pos.x,this.pos.y)}isVisible(){return m.wasm.is_visible(this.pos.x,this.pos.y)}isSelectable(){return this.getData().selectable}isDrillable(){const e=this.getData().drillLevel;return void 0!==e&&e<=I.drillLevel}getOutline(){return this.rect}getDescription(){return`${d[this.type]}`}getInfo(){return""}getOptionMenu(e){let t=[];return this.isDrillable()?t.push({name:"Mark for Drill",callback:()=>{for(const t of e){const e=new n({pos:t.pos,range:1,duration:t.getData().strength,requirements:{emptyHand:!0,tile:{pos:t.pos,type:t.type}}},()=>I.place(t.pos,d.Debris));I.scheduler.addJob(e)}return!0}}):this.type==d.Air&&h.map((e,t)=>({data:e,type:t})).filter(e=>e.data.buildable).map(t=>({name:"Build "+l[t.type],callback:()=>{for(const s of e)c.constructMachine(s.pos,t.type);return!0}})).forEach(e=>t.push(e)),t}static at(e,t=0){return e instanceof v||(e=new v(e,t)),e.isValid()?(m.tiles[e.x]||(m.tiles[e.x]=[]),m.tiles[e.x][e.y]||(m.tiles[e.x][e.y]=new m(e)),m.tiles[e.x][e.y]):null}}m.tiles=[];const p=[{name:"Air",strength:-1,selectable:!0,leavesDebris:!1},{name:"Bedrock",strength:-1,selectable:!1,leavesDebris:!1},{name:"Granite",strength:20,drillLevel:1,selectable:!0,leavesDebris:!0,drops:[{item:r.Ore,probability:.1},{item:r.Crystal,probability:.05}]},{name:"Stone",strength:4,drillLevel:0,selectable:!0,leavesDebris:!0,drops:[{item:r.Ore,probability:.2},{item:r.Crystal,probability:.05}]},{name:"Ore",strength:7,drillLevel:0,selectable:!0,leavesDebris:!0,drops:[{item:r.Ore,probability:1},{item:r.Ore,probability:1},{item:r.Ore,probability:.25},{item:r.Ore,probability:.1}]},{name:"Crystal",strength:6,drillLevel:0,selectable:!0,leavesDebris:!0,drops:[{item:r.Crystal,probability:1},{item:r.Crystal,probability:1},{item:r.Crystal,probability:.3},{item:r.Crystal,probability:.1}]},{name:"Debris",strength:5,drillLevel:0,selectable:!0,leavesDebris:!1,drops:[{item:r.Ore,probability:1},{item:r.Ore,probability:.1}]},{name:"Platform",strength:-1,selectable:!1,leavesDebris:!0},{name:"Machine",strength:-1,selectable:!1,leavesDebris:!1}];var f,w,g;!function(e){e[e.LowPower=0]="LowPower"}(f||(f={}));class y{static init(e,t){y.wasm=e,y.assets=t,y.wasm.init(y.width,y.height),y.canvas=document.createElement("canvas"),y.canvas.width=y.width*y.tileSize,y.canvas.height=y.height*y.tileSize}static place(e,t){y.wasm.set(e.x,e.y,t),y.wasm.set_visible(e.x,e.y),y.needsDrawing=!0}static draw(e,t){if(!y.needsDrawing)return void e.drawImage(y.canvas,0,0);y.needsDrawing=!1;const s=t&&y.debugParams.ignoreVisibility,i=y.canvas.getContext("2d");if(!i)throw new Error("Canvas 2d-Mode not supported");i.fillStyle="black",i.fillRect(0,0,y.canvas.width,y.canvas.height),i.fillStyle="white";const o=new v(0,0);for(o.y=0;o.y<y.height;o.y++)for(o.x=0;o.x<y.width;o.x++)if(s||y.wasm.is_visible(o.x,o.y)){i.fillRect(o.x*y.tileSize,o.y*y.tileSize,y.tileSize,y.tileSize);const e=y.wasm.get(o.x,o.y);if(y.wasm.get(o.x,o.y)==d.Platform){const e=[0,1,2,3].map(e=>{const t=o.getInDir(e);if(!t.isValid())return!1;const s=y.wasm.get(t.x,t.y);return s==d.Platform||s==d.Machine}).map(e=>e?1:0).reduceRight((e,t)=>e<<1|t,0);i.drawImage(y.assets,16*e,32,16,16,o.x*y.tileSize,o.y*y.tileSize,y.tileSize,y.tileSize)}else i.drawImage(y.assets,16*e,0,16,16,o.x*y.tileSize,o.y*y.tileSize,y.tileSize,y.tileSize)}if(!t||-1==y.debugParams.hpaLevel)return void e.drawImage(y.canvas,0,0);i.strokeStyle="red",i.beginPath();const n=y.wasm.chunk_size();for(let e=0;e<y.height;e+=n)i.moveTo(0,e*y.tileSize),i.lineTo(y.canvas.width,e*y.tileSize);for(let e=0;e<y.width;e+=n)i.moveTo(e*y.tileSize,0),i.lineTo(e*y.tileSize,y.canvas.height);i.stroke();const r=["black"];for(let e=1;e<4*n;e++){let t=e/(4*n);r.push("rgb("+255*t+", "+(255-255*t)+", 0)")}y.wasm.iter_links();let a=0,l=0;for(;y.wasm.next_link();){a++;const e=y.wasm.link_x(),t=y.wasm.link_y();y.wasm.link_id();if(i.strokeStyle="red",i.strokeRect(e*y.tileSize+1,t*y.tileSize+1,y.tileSize-2,y.tileSize-2),y.debugParams.edges)for(;y.wasm.next_connection();){l++;const s=y.wasm.connection_x(),o=y.wasm.connection_y(),n=y.wasm.connection_cost();i.strokeStyle=r[n],i.beginPath(),i.moveTo((e+.5)*y.tileSize,(t+.5)*y.tileSize);const a=(e+.5+(s+.5))/2,h=(t+.5+(o+.5))/2;i.lineTo(a*y.tileSize,h*y.tileSize),i.stroke()}}console.log("Links: ",a),console.log("Connections: ",l),e.drawImage(y.canvas,0,0)}static drawMachine(e,t,s){e.drawImage(y.assets,16*t,16,16,16,s.x,s.y,s.width,s.height)}static drawSymbol(e,t,s){e.drawImage(y.assets,16*t,48,16,16,s.x,s.y,s.width,s.height)}static genPath(e,t){if(e.x==t.x&&e.y==t.y)return new i(e,t,0,w.NONE);if(!e.isValid()||!t.isValid())return null;let s=y.wasm.find_path(e.x,e.y,t.x,t.y);if(s<0)return null;const o=3&s;return new i(e,t,s>>=2,o)}static genPaths(e,t){if(0==e.length||0==t.length)return new Map;const s=t.map(e=>e.isValid()?e:null),o=e.map(e=>e.isValid()?e:null);for(const e of s)e&&y.wasm.add_flood_goal(e.x,e.y);const n=new Map;for(const e of o){if(!e)continue;const t=new Map;y.wasm.flood_search(e.x,e.y);for(const o of s){if(!o)continue;const s=y.wasm.flood_path_to(o.x,o.y);if(-1==s)continue;const n=3&s,r=s>>2;t.set(o,new i(e,o,r,n))}n.set(e,t)}return y.wasm.end_flood_search(),n}static revealWorld(){for(let e=1;e<127;e++)for(let t=1;t<127;t++)y.wasm.set_visible(e,t);y.needsDrawing=!0}}y.width=128,y.height=128,y.tileSize=16,y.needsDrawing=!0,y.debugParams={hpaLevel:-1,edges:!1,ignoreVisibility:!1},function(e){e[e.UP=0]="UP",e[e.RIGHT=1]="RIGHT",e[e.DOWN=2]="DOWN",e[e.LEFT=3]="LEFT",e[e.NONE=4]="NONE"}(w||(w={}));class b{constructor(e,t){this.set(e,t)}set(e,t){return this.x=e,this.y=t,this}move(e,t=1){return this.x+=b.deltaX[e]*t,this.y+=b.deltaY[e]*t,this}equals(e){return this.x===e.x&&this.y===e.y}dirTo(e){return e.x>this.x?w.RIGHT:e.x<this.x?w.LEFT:e.y>this.y?w.DOWN:w.UP}xy(){return[this.x,this.y]}toString(){return"("+this.x+", "+this.y+")"}}b.deltaX=[0,1,0,-1,0],b.deltaY=[-1,0,1,0,0];class v extends b{constructor(e,t=0){super(e instanceof b?e.x:e,e instanceof b?e.y:t)}set(e,t=0){return e instanceof v?(this.x=e.x,this.y=e.y):(this.x=e,this.y=t),this}isValid(){return this.x>=0&&this.y>=0&&this.x<y.width&&this.y<y.height}plus(e,t=0){return e instanceof v?new v(this.x+e.x,this.y+e.y):new v(this.x+e,this.y+t)}minus(e,t=0){return e instanceof v?new v(this.x-e.x,this.y-e.y):new v(this.x-e,this.y-t)}scale(e){return new v(this.x*e,this.y*e)}toTilePos(){return this}getInDir(e){return new v(this).move(e)}toGamePos(){return new S(this.x*y.tileSize,this.y*y.tileSize)}distance(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}mid(){return this.plus(.5,.5).toGamePos()}}class S extends b{constructor(e,t=0){super(e instanceof b?e.x:e,e instanceof b?e.y:t)}set(e,t=0){return e instanceof S?(this.x=e.x,this.y=e.y):(this.x=e,this.y=t),this}isValid(){return this.x>=0&&this.y>=0&&this.x<I.width&&this.y<I.height}plus(e,t=0){return e instanceof S?new S(this.x+e.x,this.y+e.y):new S(this.x+e,this.y+t)}minus(e,t=0){return e instanceof S?new S(this.x-e.x,this.y-e.y):new S(this.x-e,this.y-t)}scale(e){return new S(this.x*e,this.y*e)}distance(e){return Math.sqrt(Math.pow(this.x-e.x,2)+Math.pow(this.y-e.y,2))}floor(){return new S(Math.floor(this.x),Math.floor(this.y))}toTilePos(){const e=this.scale(1/y.tileSize).floor();return new v(e.x,e.y)}toGamePos(){return this}}!function(e){e[e.Default=0]="Default",e[e.TileBrush=1]="TileBrush",e[e.WorkerSelection=2]="WorkerSelection",e[e.PlacePlatform=3]="PlacePlatform"}(g||(g={}));class x{constructor(e,t){this.brushSize=30,this.zoom=1,this.mouseMode=g.Default,this.eventRelevant=!1,this.hasMoved=!1,this.startPos=new S(0,0),this.selection=new Set,this.mouse=new S(0,0),this.rawMouse=new S(0,0),this.mouseDown=!1,this.element=e,this.onNewSelection=t;const s=new S(I.width,I.height).scale(.5),i=new S(I.SCREEN_WIDTH,I.SCREEN_HEIGHT).scale(.5);this.offset=i.minus(s),document.addEventListener("keydown",e=>{this.updateKeys(e),"Escape"==e.key&&(this.selection.clear(),this.onNewSelection(this.selection),this.eventRelevant=!1,e.preventDefault())}),document.addEventListener("keyup",e=>this.updateKeys(e)),document.addEventListener("mousedown",e=>{this.updateKeys(e),0==e.button&&(this.eventRelevant=e.target==this.element,this.handleMouseEvent(e,!0,!1))}),document.addEventListener("mousemove",e=>{this.updateKeys(e),I.getMousePos(e).equals(this.mouse)||this.handleMouseEvent(e,!1,!1)}),document.addEventListener("mouseup",e=>{this.updateKeys(e),0==e.button&&this.handleMouseEvent(e,!1,!0)}),e.addEventListener("wheel",e=>{this.updateKeys(e);const t=1-e.deltaY/1e3,s=this.element.getBoundingClientRect();this.offset.x=(e.pageX-s.left)*(1-t)+this.offset.x*t,this.offset.y=(e.pageY-s.top)*(1-t)+this.offset.y*t,this.zoom*=t,e.preventDefault()})}updateKeys(e){e.shiftKey?this.mouseMode!=g.TileBrush&&(this.mouseMode=g.TileBrush):e.ctrlKey?this.mouseMode!=g.WorkerSelection&&(this.mouseMode=g.WorkerSelection,this.mouseDown&&this.startPos.set(this.mouse)):this.mouseMode!=g.TileBrush&&this.mouseMode!=g.WorkerSelection||(this.mouseMode=g.Default,this.mouseDown&&(this.selection.clear(),this.onNewSelection(this.selection)))}handleMouseEvent(e,t,s){this.eventRelevant&&e.preventDefault();const i=I.getMousePos(e),n=I.getRawMousePos(e),r=!s&&!t;if(this.mouseDown=!s&&(t||this.mouseDown),this.hasMoved=r,t&&this.mouseMode!=g.Default&&(this.selection.clear(),this.onNewSelection(this.selection),this.startPos.set(i)),this.mouseDown&&this.eventRelevant)if(this.mouseMode==g.TileBrush)this.appendTargets(i);else if(this.mouseMode==g.PlacePlatform){const e=i.toTilePos(),t=m.at(e);t&&t.isVisible()&&I.isFree(e)&&c.constructMachine(e,l.Platform)}else if(this.mouseMode==g.Default&&r){const e=n.minus(this.rawMouse);this.offset=this.offset.plus(e)}if(s&&this.eventRelevant){if(this.mouseMode==g.WorkerSelection){const e=new o(this.startPos,i);for(const t of I.scheduler.workers)e.intersects(t.getOutline())&&this.selection.add(t)}else if(this.mouseMode==g.Default&&!this.hasMoved){this.selection.clear();const e=I.getSelectableAt(i);e&&this.selection.add(e)}this.mouseMode==g.Default&&this.hasMoved||(this.onNewSelection(this.selection),this.selection.clear())}this.mouse.set(i),this.rawMouse.set(n)}appendTargets(e){if(this.mouseMode!=g.TileBrush)return;const t=e.minus(this.brushSize,this.brushSize).toTilePos(),s=e.plus(this.brushSize,this.brushSize).toTilePos();for(let i=t.x;i<=s.x;i++)for(let o=t.y;o<=s.y;o++){const t=m.at(i,o);t&&t.isVisible()&&t.isDrillable()&&t.isSelectable()&&(t.pos.mid().toGamePos().distance(e)<this.brushSize+y.tileSize/2||t.pos.toGamePos().distance(e)<this.brushSize||t.pos.plus(1,0).toGamePos().distance(e)<this.brushSize||t.pos.plus(0,1).toGamePos().distance(e)<this.brushSize||t.pos.plus(1,1).toGamePos().distance(e)<this.brushSize)&&this.selection.add(t)}}draw(e,t){e.strokeStyle="red";for(const t of this.selection){const s=t.getOutline();e.strokeRect(s.x,s.y,s.width,s.height)}if(e.fillStyle="rgba(180, 180, 255, 0.7)",e.beginPath(),this.mouseMode==g.TileBrush)e.ellipse(this.mouse.x,this.mouse.y,this.brushSize,this.brushSize,0,0,2*Math.PI);else if(this.mouseMode==g.WorkerSelection){if(this.mouseDown){const t=this.mouse.minus(this.startPos);e.rect(this.startPos.x,this.startPos.y,t.x,t.y)}}else{if(this.mouseMode==g.PlacePlatform){const s=this.mouse.toTilePos();return y.drawMachine(e,l.Platform,new o(s.toGamePos(),t,t)),void(I.isFree(s)||(e.fillStyle="rgba(255, 0, 0, 0.5)",e.fillRect(s.x*t,s.y*t,t,t)))}{const s=this.mouse.toTilePos();e.rect(s.x*t,s.y*t,t,t)}}e.fill()}}class P{constructor(e,t,s=!0){this.selection=new Set,this.options=[],this.buttons=[],this.mouseHandler=e,this.container=t,this.hasDefaultOptions=s,document.addEventListener("keydown",e=>{this.mouseHandler.updateKeys(e);const t=function(e){let t=e.key.toLowerCase();e.altKey&&(t="alt+"+t);e.metaKey&&(t="meta+"+t);e.shiftKey&&(t="shift+"+t);e.ctrlKey&&(t="ctrl+"+t);return t}(e);if(" "==t&&this.options.length>0)this.call(this.options[0]),e.preventDefault();else if(t.match(/^[1-9]$/)){const s=parseInt(t)-1;s<this.options.length&&(this.call(this.options[s]),e.preventDefault())}}),this.refresh()}call(e){!e||e.enabled&&!e.enabled()||(e.callback()&&this.selection.clear(),this.refresh())}refresh(){for(0==this.selection.size?this.hasDefaultOptions?this.options=this.getDefaultOptions():this.options=[]:this.options=this.selection.first().getOptionMenu(this.selection);this.buttons.length<this.options.length;){const e=document.createElement("tr");this.container.appendChild(e);const t=document.createElement("td");e.appendChild(t);const s=document.createElement("button"),i=this.buttons.length;s.addEventListener("click",()=>{this.call(this.options[i])}),t.appendChild(s),this.buttons.push(s)}for(;this.buttons.length>this.options.length;){this.buttons.pop();const e=this.container.children.item(this.container.childElementCount-1);e&&this.container.removeChild(e)}const e=this.container.getElementsByTagName("button");for(let t=0;t<this.options.length;t++){const s=this.options[t];e[t].innerText=s.name}}draw(e){e.strokeStyle="red",this.selection.forEach(t=>{const s=t.getOutline();e.strokeRect(s.x,s.y,s.width,s.height)}),this.options.forEach((e,t)=>{!e.enabled||e.enabled()?this.buttons[t].removeAttribute("disabled"):this.buttons[t].setAttribute("disabled","")})}getInfo(){if(0==this.selection.size)return"";const e=this.selection.first();if(1==this.selection.size)return e.getDescription()+"\n"+e.getInfo();{let t={},s=e.getInfo();for(const e of this.selection){const i=e.getDescription();t[i]=(t[i]||0)+1,s!=e.getInfo()&&(s="")}let i="";for(const e in t)i+=t[e]+"x "+e+"\n";return i+s}}getDefaultOptions(){let e=[];return this.mouseHandler.mouseMode!=g.PlacePlatform?e.push({name:"Place Platforms",callback:()=>(this.mouseHandler.mouseMode=g.PlacePlatform,!0)}):e.push({name:"Stop placing Platforms",callback:()=>(this.mouseHandler.mouseMode=g.Default,!0)}),e}}class k{constructor(e){this.list=new Set,this.capacity=e||1/0}[Symbol.iterator](){return this.list[Symbol.iterator]()}get count(){return this.list.size}hasRoom(){return this.count<this.capacity}contains(e){return this.list.has(e)}add(e){if(!this.hasRoom())return!1;const t=this.count;return this.list.add(e).size>t}remove(e){return this.list.delete(e)}}class M extends k{constructor(){super(...arguments),this.requests=new Array,this.unresolved=new Array}request(e,t,s=0){this.requests.push(new D(e,t,s))}create(e,t,s){throw new Error("Not implemented!")}}class D{constructor(e,t,s=0){this.target=e,this.priority=s,this.cost=t,this.items=[]}}class z{constructor(){this.map={},this.list=new Set,this.spawnList=new Set}[Symbol.iterator](){return this.list[Symbol.iterator]()}get count(){return this.list.size}contains(e){return this.list.has(e)}add(e){if(this.map[e.pos.toString()])return!1;this.map[e.pos.toString()]=e,e.type==l.Spawn&&this.spawnList.add(e);const t=this.count;return this.list.add(e).size>t}remove(e){return delete this.map[e.pos.toString()],this.spawnList.delete(e),this.list.delete(e)}spawns(){return this.spawnList}at(e,t=0){return e instanceof v||(e=new v(e,t)),this.map[e.toString()]}}class E{constructor(){this.list={}}add(e,t=1){const s=this.get(e);this.list[e]=t+s}get(e){return this.list[e]||0}remove(e,t){this.list[e]=Math.max(0,this.get(e)-t)}spawnItem(e,t,s){if(0==this.get(e))return null;throw new Error("Not implemented!")}draw(){let e="";for(const t in this.list){const s=parseInt(t);e+=r[s]+": "+this.get(s)+"\n"}e&&("\n"!=e[e.length-1]&&(e+="\n"),e+="--------------------"),this.display.innerText=e}}class T extends k{constructor(){super(20)}}class R{constructor(e,t){this.item=null,this.moveDelay=0,this.totalMoveDelay=0,this.parent=e,this.pos=new v(t),this.absolutePosition=this.pos.toGamePos()}isMoving(){return this.moveDelay>0}setMovement(e,t){this.moveDirection=e,this.moveDelay=this.totalMoveDelay=t}updateMovement(){return!!this.isMoving()&&(this.moveDelay--,this.isMoving()||(this.pos.move(this.moveDirection),this.item&&(this.item.pos=this.pos.mid())),this.isMoving())}animationUpdate(e){if(this.isMoving()){const t=1-this.moveDelay/this.totalMoveDelay+1/this.totalMoveDelay*e,s=this.pos.toGamePos(),i=this.pos.getInDir(this.moveDirection).toGamePos().minus(s).scale(t);this.absolutePosition.set(this.pos.toGamePos().plus(i))}else this.absolutePosition.set(this.pos.toGamePos())}draw(e,t){e.fillStyle="red";const s=this.getOutline();e.fillRect(s.x,s.y,s.width,s.height)}getOutline(){const e=y.tileSize/5,t=this.absolutePosition.plus(e,e),s=t.plus(y.tileSize-2*e,y.tileSize-2*e);return new o(t,s)}getDescription(){return"Worker"}getInfo(){let e="";return this.item&&(e+="Carrying: "+this.item.getDescription()+"\n"),e}getOptionMenu(e){return[{name:"Return to Base",callback:()=>(e.forEach(e=>e.parent.removeWorker(e)),!0)}]}}class C{constructor(e,t,s,i){this.worker=e,this.job=t,this.path=s,this.startTime=i}endTime(){return this.startTime+this.path.length+this.job.duration}}class O{constructor(){this.schedule=new Map,this.tasks=new Set,this.time=0,this.workers=new T,this.items=new M,this.resources=new E,this.machines=new z,this.requests=[],this.unassigned=[]}tick(){this.time++;const e=new Set,t=new Set;for(const s of this.workers){if(s.isMoving()){s.updateMovement();continue}const i=this.schedule.get(s);if(!i||0==i.length){e.add(s);continue}const o=i[0];O.stillValid(o)?t.add(s):(i.length=0,e.add(s))}for(const e of t){const t=this.schedule.get(e);if(void 0===t)throw new Error("Worker does not exist");const s=t[0];if(e.pos.distance(s.job.pos)<=s.job.range)s.job.onFinished(e),t.removeAt(0);else{const t=y.genPath(e.pos,s.job.pos);if(!t)throw new Error("TODO");s.path=t,e.setMovement(t.next,m.at(e.pos).getWalkCost())}}if(this.unassigned.length>0&&e.size>0){const t=[...e],s=y.genPaths(t.map(e=>e.pos),this.unassigned.map(e=>e.pos));let i=[];for(const e of t){const t=s.get(e.pos);if(!t)throw new Error("Worker in invalid Pos");for(const s of this.unassigned){const o=t.get(s.pos);o&&O.checkRequirements(s.requirements,e)&&i.push({worker:e,path:o,job:s})}}for(i.sort((e,t)=>e.path.length-t.path.length);i.length>0;){const e=i.splice(0,1)[0],t=new C(e.worker,e.job,e.path,this.time);this.addTask(t),i=i.filter(({worker:t,job:s})=>t!==e.worker&&s!==e.job)}}}static stillValid(e){return O.checkRequirements(e.job.requirements,e.worker)}static checkRequirements(e,t){if(e.emptyHand&&t.item)return!1;if(void 0!==e.item&&(!t.item||e.item!=t.item.type))return!1;if(void 0!==e.tile)if(e.tile instanceof Array){if(!e.tile.every(O.checkTileRequirements))return!1}else if(!O.checkTileRequirements(e.tile))return!1;return!0}static checkTileRequirements(e){const t=m.at(e.pos);if(void 0!==e.solid&&e.solid!=t.isSolid())return!1;if(void 0!==e.type)if(e.type instanceof Array){if(-1==e.type.indexOf(t.type))return!1}else if(e.type!=t.type)return!1;return!0}nextAvailable(e){const t=this.schedule.get(e);return t?t.map(e=>e.endTime()).max():this.time}addWorker(e){return this.workers.add(new R(this,e))}removeWorker(e){return this.workers.remove(e)}addMachine(e,t,s={}){return this.machines.add(new c(this,e,t,s))}removeMachine(e){return this.machines.remove(e)}addJob(e){this.unassigned.push(e)}addTask(e){this.tasks.add(e);this.schedule.get(e.worker);this.schedule.has(e.worker)?this.schedule.get(e.worker).push(e):this.schedule.set(e.worker,[e])}animationUpdate(e){for(const t of this.workers)t.animationUpdate(e)}countResource(e){return this.resources.get(e)}request(e){this.requests.push(e)}isAvailable(e){for(const t of e.amount.keys())if(this.resources.get(t)<e.amount.get(t))return!1;return!0}pay(e){for(const t of e.amount.keys())this.resources.remove(t,e.amount.get(t))}}class I{static get width(){return y.width*y.tileSize}static get height(){return y.height*y.tileSize}static init(e,t){function s(){const e=I.canvas.getBoundingClientRect();I.SCREEN_WIDTH=e.width,I.SCREEN_HEIGHT=e.height,I.canvas.width=I.SCREEN_WIDTH,I.canvas.height=I.SCREEN_HEIGHT}m.wasm=e,y.init(e,t),I.canvas=document.getElementById("canvas"),window.addEventListener("resize",s),s(),I.menu.info=document.getElementById("info"),I.mouseHandler=new x(I.canvas,e=>I.menu.onNewSelection(e));const i=document.getElementById("options");I.menu.side=new P(I.mouseHandler,i);const o=document.getElementById("contextMenu");I.menu.context=new P(I.mouseHandler,o,!1),I.canvas.addEventListener("click",e=>{I.menu.context.selection.clear(),I.menu.context.refresh()}),I.canvas.addEventListener("contextmenu",e=>{const t=I.getMousePos(e),s=I.getSelectableAt(t.toGamePos());t.isValid()&&e.preventDefault(),I.menu.context.container.style.left=e.pageX+"px",I.menu.context.container.style.top=e.pageY+"px",s?(I.menu.context.selection.clear(),I.menu.context.selection.add(s),I.menu.side.selection.clear()):I.menu.context.selection.clear(),I.menu.refresh()});const n=y.width/2,r=y.height/2;I.scheduler.machines.add(new c(I.scheduler,new v(n,r),l.Spawn));for(let e=1;e<3;e++)I.scheduler.machines.add(new c(I.scheduler,new v(n,r+e),l.Platform));for(let e=1;e<5;e++)I.scheduler.machines.add(new c(I.scheduler,new v(n,r-e),l.Platform));I.scheduler.machines.add(new c(I.scheduler,new v(n-1,r-4),l.Platform));for(let e=1;e<4;e++)c.constructMachine(new v(n-e,r),l.Platform);for(let e=1;e<3;e++)I.scheduler.machines.add(new c(I.scheduler,new v(n+e,r),l.Platform));for(let e=0;e<2;e++)I.scheduler.machines.add(new c(I.scheduler,new v(n+3,r+e),l.Platform));I.scheduler.machines.add(new c(I.scheduler,new v(n+3,r+2),l.Lab)),I.scheduler.addWorker(new v(n-1,r-1)),I.scheduler.addWorker(new v(n-1,r+1)),I.scheduler.addWorker(new v(n,r-1)),I.scheduler.addWorker(new v(n,r+1)),I.scheduler.addWorker(new v(n+1,r-1)),I.scheduler.addWorker(new v(n+1,r)),I.scheduler.addWorker(new v(n+1,r+1)),I.scheduler.resources.display=document.getElementById("resources");const a=new URL(window.location.toString()).searchParams;function h(e,t=0){return a.has(e)&&a.get(e).match(/^\d+$/)?parseInt(a.get(e)):t}function u(e,t=!1){return a.has(e)?"false"!=a.get(e)&&"0"!=a.get(e):t}(u("debug")||u("debugMode"))&&I.debugMode(),u("debugDisplay")?(I.debugDisplay(),-1==h("hpaLevel",0)&&(y.debugParams.hpaLevel=-1),u("edges",!0)||(y.debugParams.edges=!1),u("ignoreVisibility",!0)||(y.debugParams.ignoreVisibility=!1)):(y.debugParams.hpaLevel=h("hpaLevel",-1),y.debugParams.edges=u("edges"),y.debugParams.ignoreVisibility=u("ignoreVisibility")),requestAnimationFrame(I.update)}static update(e){requestAnimationFrame(I.update);const t=e-I.time;I.time=e,I.timeDebt+=t,I.timeDebt>=I.gameSpeed&&(I.timeDebt=0,I.tick()),I.animationUpdate(I.timeDebt/I.gameSpeed),I.draw()}static tick(){I.scheduler.tick()}static animationUpdate(e){I.scheduler.animationUpdate(e)}static draw(){const e=I.canvas.getContext("2d");if(!e)throw new Error("Canvas 2d-Mode not supported");e.imageSmoothingEnabled=!1,e.setTransform(1,0,0,1,0,0),e.fillStyle="#333333",e.fillRect(0,0,I.canvas.width,I.canvas.height),e.setTransform(I.mouseHandler.zoom,0,0,I.mouseHandler.zoom,I.mouseHandler.offset.x,I.mouseHandler.offset.y),y.draw(e,I.debugDisplayActive);for(const t of I.scheduler.machines)t.draw(e);for(const t of I.scheduler.workers)t.draw(e,y.tileSize);for(const t of I.scheduler.items)t.draw(e);I.menu.side.draw(e),I.menu.context.draw(e);let t="";if(I.menu.side.selection.size?t=I.menu.side.getInfo():I.menu.context.selection.size&&(t=I.menu.context.getInfo()),t&&("\n"!=t[t.length-1]&&(t+="\n"),t+="--------------------"),I.menu.info.innerText=t,I.scheduler.resources.draw(),I.mouseHandler.draw(e,y.tileSize),I.debugDisplayActive){const t=I.mouseHandler.mouse.toTilePos();e.setTransform(1,0,0,1,0,0);const s=e.font.split(" "),i=s[s.length-1];e.font=y.tileSize+"px "+i;const o=e.measureText(Math.max(t.x,t.y).toString()).width;e.fillStyle="black",e.fillRect(0,0,o+8,2*y.tileSize+8),e.fillStyle="white",e.fillRect(2,2,o+4,2*y.tileSize+4),e.strokeStyle="black",e.strokeText(t.x.toString(),4,y.tileSize+2),e.strokeText(t.y.toString(),4,2*y.tileSize+2)}}static place(e,t){y.place(e,t);const s=m.at(e);I.mouseHandler.selection.delete(s),I.menu.side.selection.delete(s),I.menu.context.selection.delete(s)}static getRawMousePos(e){const t=I.canvas.getBoundingClientRect();return new S(e.pageX,e.pageY).minus(t.left,t.top)}static getMousePos(e){return I.getRawMousePos(e).minus(I.mouseHandler.offset).scale(1/I.mouseHandler.zoom)}static isFree(e){if(!e.isValid())return!1;const t=m.at(e);if(!t.isVisible()||t.type!=d.Air)return!1;const s=t.getOutline();for(const e of I.scheduler.workers)if(e.getOutline().intersects(s))return!1;for(const e of I.scheduler.items)if(e.getOutline().intersects(s))return!1;for(const e of I.scheduler.machines)if(e.getOutline().intersects(s))return!1;return!0}static getSelectableAt(e){if(!e.isValid())return null;const t=e.toTilePos(),s=m.at(t);if(!s.isVisible())return null;for(const t of I.scheduler.workers)if(t.getOutline().contains(e))return t;for(const t of I.scheduler.items)if(t.getOutline().contains(e))return t;for(const t of I.scheduler.machines)if(t.getOutline().contains(e))return t;return s.isSelectable()?s:null}static debugMode(){if(!I.debugModeActive){I.debugModeActive=!0,I.gameSpeed=0,I.mouseHandler.brushSize=60;for(const e of I.scheduler.machines)e.level=100;c.debugMode(),I.scheduler.resources.add(r.Ore,1e6),I.scheduler.resources.add(r.Crystal,1e6),y.needsDrawing=!0}}static debugDisplay(){I.debugDisplayActive=!I.debugDisplayActive,y.needsDrawing=!0,I.debugDisplayActive&&(y.debugParams.hpaLevel=0,y.debugParams.edges=!0,y.debugParams.ignoreVisibility=!0)}}I.menu=new class{onNewSelection(e){this.side.selection.clear(),e.forEach(e=>this.side.selection.add(e)),this.context.selection.clear(),this.refresh()}refresh(){this.side.refresh(),this.context.refresh()}remove(e){this.side.selection.delete(e),this.context.selection.delete(e),this.refresh()}},I.scheduler=new O,I.drillLevel=0,I.drillSpeed=1,I.time=0,I.timeDebt=0,I.gameSpeed=200,I.debugModeActive=!1,I.debugDisplayActive=!1,I.SCREEN_WIDTH=40*y.width,I.SCREEN_HEIGHT=40*y.height,window.Game=I,window.World=y;let L,A=new TextDecoder("utf-8");const _={env:{random:Math.random,log_str:function(e,t){const s=L.buffer.slice(e,e+t);console.log(A.decode(s))},err_str:function(e,t){const s=L.buffer.slice(e,e+t);console.error(A.decode(s))}}},W=fetch("lib.wasm").then(e=>e.arrayBuffer()).then(e=>WebAssembly.instantiate(e,_)).then(e=>e.instance.exports),H=new Promise((e,t)=>window.addEventListener("load",e)).then(()=>createImageBitmap(document.getElementById("assets")));Promise.all([H,W]).then(([e,t])=>{L=t.memory,I.init(t,e)}),Array.prototype.min=function(e){if(0==this.length)return null;let t=0,s=e?e(this[0],0,this):this[0];for(let i=1;i<this.length;i++){const o=e?e(this[i],i,this):this[i];o<s&&(t=i,s=o)}return this[t]},Array.prototype.max=function(e){if(0==this.length)return null;let t=0,s=e?e(this[0],0,this):this[0];for(let i=1;i<this.length;i++){const o=e?e(this[i],i,this):this[i];o>s&&(t=i,s=o)}return this[t]},Array.prototype.remove=function(e){let t=this.indexOf(e);return-1!=t&&this.splice(t,1),-1!=t},Array.prototype.removeAt=function(e){const t=this.splice(e,1);return t?t[0]:null},Array.prototype.removeWhere=function(e){const t=[];for(let s=0;s<this.length;s++)e(this[s])&&t.push(this.removeAt(s--));return t},Set.prototype.first=function(){return this.values().next().value}}]);